generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model equipamento {
  id                            Int                             @id @default(autoincrement())
  nome                          String
  api_key                       String?                         @db.Text
  id_cliente                    Int?
  created_at                    DateTime?                       @default(now()) @db.DateTime(0)
  created_by                    Int?
  cliente                       cliente?                        @relation(fields: [id_cliente], references: [id], onDelete: Cascade, map: "cliente")
  created_by_usuario            usuario?                        @relation("EquipamentoCreatedBy", fields: [created_by], references: [id], map: "equipamento_created_by")
  equipamento_log_grupo         equipamento_log_grupo[]
  equipamento_metricas          equipamento_metricas[]
  usuario_equipamento_dashboard usuario_equipamento_dashboard[]

  @@index([id_cliente], map: "cliente_idx")
  @@index([created_by])
}

model equipamento_log_grupo {
  id             Int          @id @default(autoincrement())
  timestamp      DateTime?    @db.DateTime(0)
  id_equipamento Int?
  logs           Json?
  equipamento    equipamento? @relation(fields: [id_equipamento], references: [id], onDelete: Cascade, map: "equipamento_relacionado")

  @@index([id_equipamento], map: "equipamento_relacionado_idx")
}

model equipamento_metricas {
  id             Int         @id @default(autoincrement())
  id_equipamento Int
  id_metrica     Int
  valor_minimo   Float
  valor_maximo   Float
  alarme_minimo  Float?      @db.Float
  alarme_maximo  Float?      @db.Float
  equipamento    equipamento @relation(fields: [id_equipamento], references: [id], onDelete: Cascade, map: "equipamento_metrica_id_equipamento_fkey")
  metrica        metrica     @relation(fields: [id_metrica], references: [id], onDelete: Cascade, map: "equipamento_metrica_id_metrica_fkey")

  @@index([id_equipamento], map: "equipamento_metrica_id_equipamento_fkey")
  @@index([id_metrica], map: "equipamento_metrica_id_metrica_fkey")
}

model metrica {
  id                            Int                             @id @default(autoincrement())
  nome                          String
  unidade                       String
  created_at                    DateTime?                       @default(now()) @db.DateTime(0)
  created_by                    Int?
  equipamento_metricas          equipamento_metricas[]
  created_by_usuario            usuario?                        @relation("MetricaCreatedBy", fields: [created_by], references: [id], map: "metrica_created_by")
  usuario_equipamento_dashboard usuario_equipamento_dashboard[]

  @@index([created_by])
}

model perfil {
  id                     Int                      @id @default(autoincrement())
  nome                   String
  descricao              String?
  usuario_perfil         usuario_perfil[]
  usuario_perfil_cliente usuario_perfil_cliente[]
}

model usuario {
  id                                Int                             @id @default(autoincrement())
  nome                              String
  email                             String                          @unique
  senha                             String
  username                          String                          @unique
  created_at                        DateTime?                       @default(now()) @db.DateTime(0)
  created_by                        Int?
  stripe_customer_id                String?                         @unique @db.VarChar(255)
  stripe_subscription_id            String?                         @unique @db.VarChar(255)
  subscription_status               String?                         @db.VarChar(50)
  subscription_current_period_start DateTime?                       @db.DateTime(0)
  subscription_current_period_end   DateTime?                       @db.DateTime(0)
  subscription_cancel_at_period_end Boolean?                        @default(false)
  plan_name                         String?                         @db.VarChar(100)
  stripe_price_id                   String?                         @db.VarChar(255)
  created_clientes                  cliente[]                       @relation("ClienteCreatedBy")
  created_equipamentos              equipamento[]                   @relation("EquipamentoCreatedBy")
  created_metricas                  metrica[]                       @relation("MetricaCreatedBy")
  notificacoes                      notificacao[]
  password_reset_audit              password_reset_audit[]
  password_reset_token              password_reset_token[]
  created_by_usuario                usuario?                        @relation("UsuarioCreatedBy", fields: [created_by], references: [id], map: "usuario_created_by")
  created_usuarios                  usuario[]                       @relation("UsuarioCreatedBy")
  usuario_equipamento_dashboard     usuario_equipamento_dashboard[]
  usuario_perfil                    usuario_perfil[]
  usuario_perfil_cliente            usuario_perfil_cliente[]

  @@index([created_by])
  @@index([stripe_customer_id])
  @@index([stripe_subscription_id])
  @@index([subscription_status])
}

model usuario_perfil {
  id         Int     @id @default(autoincrement())
  id_usuario Int
  id_perfil  Int
  perfil     perfil  @relation(fields: [id_perfil], references: [id], onDelete: Cascade)
  usuario    usuario @relation(fields: [id_usuario], references: [id], onDelete: Cascade)

  @@index([id_perfil], map: "usuario_perfil_id_perfil_fkey")
  @@index([id_usuario], map: "usuario_perfil_id_usuario_fkey")
}

model cliente {
  id                     Int                      @id @default(autoincrement())
  nome                   String?                  @db.VarChar(255)
  cnpj                   String?                  @db.VarChar(20)
  created_at             DateTime?                @default(now()) @db.DateTime(0)
  created_by             Int?
  created_by_usuario     usuario?                 @relation("ClienteCreatedBy", fields: [created_by], references: [id], map: "cliente_created_by")
  equipamento            equipamento[]
  usuario_perfil_cliente usuario_perfil_cliente[]

  @@index([created_by])
}

model usuario_equipamento_dashboard {
  id             Int         @id @default(autoincrement())
  id_usuario     Int
  id_equipamento Int
  id_metrica     Int?
  created_at     DateTime?   @default(now()) @db.DateTime(0)
  equipamento    equipamento @relation(fields: [id_equipamento], references: [id], onDelete: Cascade)
  metrica        metrica?    @relation(fields: [id_metrica], references: [id], onDelete: Cascade)
  usuario        usuario     @relation(fields: [id_usuario], references: [id], onDelete: Cascade)

  @@unique([id_usuario, id_equipamento, id_metrica], map: "usuario_equipamento_dashboard_unique")
  @@index([id_usuario])
  @@index([id_equipamento])
  @@index([id_metrica])
}

model notificacao {
  id          Int       @id @default(autoincrement())
  id_usuario  Int
  descricao   String    @db.Text
  visualizado Boolean   @default(false)
  created_at  DateTime? @default(now()) @db.DateTime(0)
  usuario     usuario   @relation(fields: [id_usuario], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([id_usuario])
  @@index([visualizado])
  @@index([created_at])
}

model usuario_perfil_cliente {
  id         Int       @id @default(autoincrement())
  id_usuario Int
  id_cliente Int
  id_perfil  Int
  created_at DateTime? @default(now()) @db.DateTime(0)
  cliente    cliente   @relation(fields: [id_cliente], references: [id], onDelete: Cascade, onUpdate: NoAction)
  perfil     perfil    @relation(fields: [id_perfil], references: [id], onDelete: Cascade, onUpdate: NoAction)
  usuario    usuario   @relation(fields: [id_usuario], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([id_usuario, id_cliente, id_perfil], map: "usuario_perfil_cliente_unique")
  @@index([id_cliente], map: "usuario_perfil_cliente_id_cliente_fkey")
  @@index([id_perfil], map: "usuario_perfil_cliente_id_perfil_fkey")
  @@index([id_usuario], map: "usuario_perfil_cliente_id_usuario_fkey")
}

model password_reset_token {
  id         Int       @id @default(autoincrement())
  id_usuario Int
  token      String    @unique(map: "token_unique") @db.VarChar(255)
  expires_at DateTime  @db.DateTime(0)
  used       Boolean   @default(false)
  created_at DateTime? @default(now()) @db.DateTime(0)
  usuario    usuario   @relation(fields: [id_usuario], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([id_usuario], map: "id_usuario_idx")
  @@index([expires_at], map: "expires_at_idx")
  @@index([used], map: "used_idx")
}

model password_reset_audit {
  id                  Int       @id @default(autoincrement())
  id_usuario          Int
  senha_hash_anterior String    @db.VarChar(255)
  senha_hash_atual    String    @db.VarChar(255)
  created_at          DateTime? @default(now()) @db.DateTime(0)
  usuario             usuario   @relation(fields: [id_usuario], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([id_usuario], map: "id_usuario_idx")
  @@index([created_at], map: "created_at_idx")
}
